feature: xloop-ai-orchestrator
prd: ./prd-xloop.md
created_at: 2026-01-28T12:00:00Z
updated_at: 2026-01-28T12:00:00Z

tasks:
  # Phase 1: CLI Foundation
  - id: task-001
    title: "Setup project with Bun and CLI framework"
    description: |
      Initialize Bun project with package.json, tsconfig, and CLI entry point.
      Install dependencies: commander (CLI), js-yaml, ai-sdk with anthropic provider.
      Create basic CLI structure with --help and --version flags.
    status: completed
    dependencies: []
    acceptance_criteria:
      - "bun init completed with proper package.json"
      - "CLI entry point at src/index.ts or src/cli.ts"
      - "xloop --help displays usage"
      - "xloop --version displays version"
    completed_at: 2026-01-28T13:30:00Z

  - id: task-002
    title: "Implement .plans directory and config management"
    description: |
      Create utilities to manage .plans/ directory at project root.
      Auto-create directory on first use. Implement config file reading/writing
      at .plans/xloop.config.json with defaults for defaultAgent, models, commitPrefix.
    status: completed
    dependencies:
      - task-001
    acceptance_criteria:
      - ".plans/ directory auto-created if not present"
      - "Config file created with defaults on first run"
      - "Config can be read and parsed correctly"
      - "ANTHROPIC_API_KEY loaded from .env"
    completed_at: 2026-01-28T14:00:00Z

  - id: task-003
    title: "Implement --agent global flag"
    description: |
      Add --agent flag with opencode or claude options to override default agent.
      Implement agent selection priority: flag then config then fallback to claude.
    status: completed
    dependencies:
      - task-002
    acceptance_criteria:
      - "--agent flag accepts opencode or claude"
      - "Flag overrides config default"
      - "Invalid agent values show error"
    completed_at: 2026-01-28T12:41:44Z

  # refactor unit tests structure
  - id: task-004-1
    title: "Refactor unit tests structure"
    description: |
      Refactor unit tests structure to improve readability and maintainability.
    status: completed
    dependencies:
    acceptance_criteria:
      - "Tests located right next to their implementation laid out in @AGENTS.md"
    completed_at: 2026-01-28T15:00:00Z

  # Phase 2: PRD Commands
  - id: task-004
    title: "Implement --prds command (list PRDs)"
    description: |
      List all PRD files in .plans/ directory. For each PRD display filename,
      associated task file (if exists), and status derived from task file
      (not started, in progress, completed).
    status: completed
    dependencies:
      - task-002
    acceptance_criteria:
      - "Lists all prd-*.md files in .plans/"
      - "Shows associated tasks-*.yml if exists"
      - "Status calculated from task completion states"
      - "Formatted output matching PRD spec"
    completed_at: 2026-01-28T15:30:00Z

  - id: task-005
    title: "Implement --status command (task status)"
    description: |
      List all task files with uncompleted tasks. Exclude fully completed files.
      Show progress count and next task based on dependencies.
    status: completed
    dependencies:
      - task-004
    acceptance_criteria:
      - "Lists only incomplete task files"
      - "Shows X/Y tasks completed count"
      - "Shows next task respecting dependencies"
      - "Formatted output matching PRD spec"
    completed_at: 2026-01-28T13:03:32Z

  - id: task-006
    title: "Implement --prd command (generate PRD)"
    description: |
      Accept feature description text. Use AI-SDK to analyze codebase and generate
      PRD interactively with up to 5 rounds of clarifying questions. User can type
      done to proceed. Save to .plans/prd-feature-name.md.
    status: completed
    dependencies:
      - task-002
    acceptance_criteria:
      - "Accepts feature description as argument"
      - "Analyzes codebase structure"
      - "Interactive Q&A (max 5 rounds)"
      - "Typing done proceeds with current info"
      - "PRD saved with all required sections"
      - "Feature name slugified: lowercase, hyphens, max 50 chars"
    completed_at: 2026-01-28T17:00:00Z

  - id: task-006-1
    title: "fix error and write hardening tests for --prd feature"
    description: |
      the prd command is not working as expected. fix the error and write hardening tests for the --prd feature.
      output:
        I have a few questions to refine this PRD:
        âœ— Error generating PRD: 404 {type:error,error:{type:not_found_error,message:model: claude-sonnet-4},request_id:req_011CXZqdXc5Ny33XqQsbDaTh}
    status: completed
    dependencies:
      - task-006
    acceptance_criteria:
      - 'bun src/index.ts prd "email validation feature" should work, including followup questions'
      - "verified to work, not assumed"
    completed_at: 2026-01-28T14:25:00Z

  # Phase 3: Task Generation
  - id: task-007
    title: "Implement --prd-to-tasks command"
    description: |
      Accept PRD file path. Use AI-SDK to parse PRD and generate ordered task list.
      Tasks ordered by dependency. Save to .plans/tasks-feature-name.yml with
      full schema: id, title, description, status, dependencies, acceptance_criteria.
    status: completed
    dependencies:
      - task-006
    acceptance_criteria:
      - "Accepts PRD file path argument"
      - "Generates tasks from PRD content"
      - "Tasks have all schema fields"
      - "Dependencies correctly identified"
      - "YAML saved with correct naming"
    completed_at: 2026-01-28T13:35:00Z

  # Phase 4: Agent Integration
  - id: task-008
    title: "Implement agent subprocess spawning"
    description: |
      Create utilities to spawn opencode or claude as subprocesses.
      Stream stdout/stderr to console in real-time. Handle exit codes.
      Agent inherits current working directory.
    status: completed
    dependencies:
      - task-003
    acceptance_criteria:
      - "Can spawn both opencode and claude"
      - "Output streams in real-time"
      - "Exit codes captured correctly"
      - "Working directory inherited"
    completed_at: 2026-01-28T14:17:47Z

  - id: task-008-1
    title: "fix exit and output streams from agents"
    description: |
      The agents kept streaming data to the console even after a ctrl+c command.
      Ensure proper handling of exit codes and output streams.
    status: completed
    dependencies:
      - task-008
    acceptance_criteria:
      - "Agents stop streaming data after ctrl+c"
      - "Exit codes captured correctly"
      - "Output streams handled properly"
    completed_at: 2026-01-28T15:00:00Z

  - id: task-009
    title: "Implement agent prompt construction"
    description: |
      Build structured prompts for agent invocations including AGENTS.md content,
      task file content, progress file content. Different prompts for implement,
      review, and finalize phases.
      Good prompt and agent invocations can be found in old-loop/once.sh. There it's referencing files, which in turn
      tell the agent what to do. But this prompt is not separated into phases, so keep that in mind, we want separated in xloop.
      What's not ideal in that example is in the old-loop/prompt.md that project specific things are hardcoded. xloop is
      meant to be language and framework agnostic, so the prompt should be generic and adaptable to different contexts.
      So parts of the prompt (how to run tests, linting etc to get feedback) should be configurable via the config file.
    status: completed
    dependencies:
      - task-008
    acceptance_criteria:
      - "Prompt includes AGENTS.md if exists"
      - "Prompt includes task file content"
      - "Prompt includes progress file if exists"
      - "Different prompts for each phase"
      - "Parts of the prompt is configurable via config file"
    completed_at: 2026-01-28T15:30:00Z

  - id: task-009-1
    title: "don't read te files and add to prompt, reference them"
    description: |
      the agents (opencode, claude) can take references to AGENTS.md, tasks-<feature>.yml, progress-<feature>.txt etc
      instead of reading the files and adding their content to the prompt, they can reference them in the prompt.
      This reduces the prompt size and improves performance. Just add @<file_path> in the prompt.
    status: pending
    dependencies:
      - task-008
    acceptance_criteria:
      - "References @AGENTS.md, @.plans/tasks-<feature>.yml, @.plans/progress-<feature>.txt etc"
    completed_at: null

  # Phase 5: --do Command
  - id: task-010
    title: "Implement --do command basic structure"
    description: |
      Accept tasks file path and required -i/--iterations flag.
      Optional --skip=review flag. Loop for n iterations.
    status: pending
    dependencies:
      - task-009
    acceptance_criteria:
      - "Accepts tasks file path"
      - "-i/--iterations required"
      - "--skip=review optional flag"
      - "Loops correct number of iterations"
    completed_at: null

  - id: task-011
    title: "Implement iteration workflow - Invocation 1 (Implement)"
    description: |
      First agent invocation: send context and prompt agent to pick most important
      uncompleted task respecting dependencies and implement it. Capture which
      task was selected.
    status: pending
    dependencies:
      - task-010
    acceptance_criteria:
      - "Sends correct context to agent"
      - "Agent selects task based on priority/dependencies"
      - "Task selection captured from output"
      - "Progress displayed to user"
    completed_at: null

  - id: task-012
    title: "Implement iteration workflow - Invocation 2 (Review)"
    description: |
      Second agent invocation: review changes just made. Check for correctness,
      tests, security, performance. Skipped if --skip=review flag.
    status: pending
    dependencies:
      - task-011
    acceptance_criteria:
      - "Reviews git diff/changes"
      - "Provides specific feedback"
      - "Skipped when --skip=review"
      - "Feedback captured for next phase"
    completed_at: null

  - id: task-013
    title: "Implement iteration workflow - Invocation 3 (Finalize)"
    description: |
      Third agent invocation: apply review feedback, update tasks YAML (mark completed),
      append to progress file, optionally update AGENTS.md, commit with proper message
      format: feature-taskid followed by descriptive message.
    status: pending
    dependencies:
      - task-012
    acceptance_criteria:
      - "Review feedback applied"
      - "tasks-*.yml updated with completed status"
      - "progress-*.txt updated with iteration summary"
      - "AGENTS.md updated if useful learnings"
      - "Git commit with proper message format"
    completed_at: null

  - id: task-014
    title: "Implement failure handling for --do"
    description: |
      If task fails (agent cannot complete, tests fail), immediately exit.
      Don't mark failed task as completed. Display error with details.
      On next run, same task will be selected.
    status: pending
    dependencies:
      - task-013
    acceptance_criteria:
      - "Failures exit immediately"
      - "Failed task not marked completed"
      - "Error details displayed"
      - "Task remains pending for next run"
    completed_at: null

  # Phase 6: Error Handling & Polish
  - id: task-015
    title: "Implement comprehensive error handling"
    description: |
      Handle all common errors: missing API key, invalid paths, agent not found,
      git not initialized, network errors. Implement retry with exponential backoff
      for network errors (3 retries).
    status: pending
    dependencies:
      - task-014
    acceptance_criteria:
      - "Missing API key shows setup instructions"
      - "Invalid paths show File not found"
      - "Missing agent shows install instructions"
      - "Network errors retry 3x with backoff"
      - "Error format matches PRD spec"
    completed_at: null

  - id: task-016
    title: "Add progress file management"
    description: |
      Create/update progress-feature.txt with iteration summaries.
      Format: iteration header, summary, files changed, review notes, commit hash.
    status: pending
    dependencies:
      - task-013
    acceptance_criteria:
      - "Progress file created on first iteration"
      - "Each iteration appended with separator"
      - "Contains all required fields"
      - "Commit hash recorded"
    completed_at: null

  - id: task-017
    title: "Implement AGENTS.md management"
    description: |
      Read AGENTS.md from project root if exists. Agent instructed to update
      with useful learnings during finalize phase. Create if doesn't exist.
      Append under fitting heading or create new heading.
    status: pending
    dependencies:
      - task-013
    acceptance_criteria:
      - "AGENTS.md read if exists"
      - "Created by agent if not present"
      - "Learnings appended under headings"
      - "Format matches PRD examples"
    completed_at: null

  - id: task-018
    title: "Add unit tests for core utilities"
    description: |
      Write tests using bun test for: config management, file naming/slugify,
      task status calculation, YAML parsing, prompt construction.
    status: pending
    dependencies:
      - task-017
    acceptance_criteria:
      - "Config read/write tested"
      - "Slugify function tested"
      - "Status calculation tested"
      - "YAML parsing tested"
      - "All tests pass with bun test"
    completed_at: null

  - id: task-019
    title: "Add integration tests for CLI commands"
    description: |
      Test CLI commands end-to-end: --prds, --status with mock .plans/ data.
      Test --prd and --prd-to-tasks with mocked AI responses.
    status: pending
    dependencies:
      - task-018
    acceptance_criteria:
      - "--prds tested with mock data"
      - "--status tested with mock data"
      - "AI operations tested with mocks"
      - "All tests pass"
    completed_at: null

  - id: task-020
    title: "Final polish and documentation"
    description: |
      Ensure all output formatting matches PRD spec. Add README with usage
      examples. Verify all acceptance criteria from PRD met.
    status: pending
    dependencies:
      - task-019
    acceptance_criteria:
      - "Output formatting matches spec"
      - "README with examples"
      - "All PRD acceptance criteria verified"
      - "Package ready for use"
    completed_at: null
