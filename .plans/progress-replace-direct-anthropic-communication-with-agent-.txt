================================================================================
TASK-001: Audit existing Anthropic API usage in codebase
Date: 2026-01-29T10:15:00.000Z
================================================================================

Summary:
Completed comprehensive audit of all direct Anthropic API usage. Found 2 files (prd-generator.ts, task-generator.ts) with 3 total API calls. Documented model selection patterns, streaming implementations (none found), error handling (retryWithBackoff), and phase-specific patterns (phase ops use agent subprocess spawning, non-phase ops use direct API).

Files Changed:
- .plans/anthropic-api-audit.md (created - comprehensive audit documentation)
- .plans/tasks-replace-direct-anthropic-communication-with-agent-.yml (modified - marked task-001 completed)
- src/prd-generator.ts (modified - fixed model name inconsistency claude-sonnet-4 → claude-sonnet-4-20250514)

Key Decisions:
- Catalogued all API usage into dedicated audit document for reference
- Identified model name inconsistency requiring immediate fix
- Confirmed phase-specific operations already use agent subprocess spawning
- Non-phase operations (PRD generation, task generation) still use direct API
- Next phase will focus on analyzing agent service interfaces

Next Task: task-002

================================================================================
TASK-002: Analyze agent service interfaces and capabilities
Date: 2026-01-29T10:45:00.000Z
================================================================================

Summary:
Completed comprehensive analysis of opencode and claude agent interfaces. Both agents support model selection via command-line flags, streaming responses, and non-interactive operation. Documented command syntax, model formats, streaming capabilities, error handling, and configuration parameters.

Files Changed:
- .plans/agent-service-analysis.md (created - comprehensive agent interface documentation)
- .plans/tasks-replace-direct-anthropic-communication-with-agent-.yml (modified - marked task-002 completed)

Key Findings:
- OpenCode: Uses `opencode run` with `--model provider/model` format (e.g., `anthropic/claude-sonnet-4-20250514`)
- Claude: Uses `claude -p` with `--model` flag supporting aliases (sonnet/opus) or full names
- Both support streaming: opencode via `--format json`, claude via `--output-format stream-json`
- Error handling via exit codes and stderr output
- Current spawnAgent() implementation needs model parameter support
- Model name transformation required: config value → agent-specific format

Key Decisions:
- OpenCode requires `anthropic/` prefix for model names
- Claude can use model names as-is from config
- Streaming support not required initially (no current usage)
- Error handling will parse stderr for user-facing messages
- Phase-specific model config will be added to HoneConfig interface

Recommendations:
1. Extend spawnAgent() to accept model parameter
2. Implement model name transformation logic
3. Add phase-specific model configuration to config schema
4. Maintain retry logic for agent spawn failures
5. Surface agent errors directly to users via stderr

Next Task: task-003

================================================================================
TASK-003: Design agent communication abstraction layer
Date: 2026-01-29T11:15:00.000Z
================================================================================

Summary:
Designed comprehensive abstraction layer to replace direct Anthropic SDK calls with agent subprocess calls. Created AgentClient class that mirrors Anthropic SDK API, defined model transformation logic (opencode needs 'anthropic/' prefix), prompt construction from message requests, response parsing from stdout, and error handling/retry strategy.

Files Changed:
- .plans/agent-communication-abstraction-design.md (created - comprehensive design documentation with interfaces, transformation logic, migration strategy)
- .plans/tasks-replace-direct-anthropic-communication-with-agent-.yml (modified - marked task-003 completed)

Key Decisions:
- Mirror Anthropic SDK API to minimize migration code changes
- Extend spawnAgent() with model parameter instead of creating separate function
- Transform model names: opencode requires 'anthropic/' prefix, claude uses as-is
- Parse stdout as plain text into Anthropic-compatible response structure
- Maintain retryWithBackoff pattern treating agent spawn/exit failures as retryable
- Phase-specific model config deferred to task-004 (optional enhancement)
- Streaming support documented but not implemented (not needed for current usage)
- AgentClient constructor takes { agent, model, workingDir } config
- Response format: { content: [{ type: 'text', text: stdout }] } for compatibility

Migration Path:
1. Create src/agent-client.ts with AgentClient class
2. Update src/agent.ts spawnAgent() to accept model parameter
3. Replace prd-generator.ts calls (2 locations)
4. Replace task-generator.ts calls (1 location)
5. Remove Anthropic SDK dependency

Next Task: task-004

