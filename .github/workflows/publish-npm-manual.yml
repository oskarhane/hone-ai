name: Publish to NPM (Manual)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (e.g., 0.5.0)"
        required: true
        type: string
      confirm:
        description: 'Type "CONFIRM" to proceed with NPM publish'
        required: true
        default: ""

permissions:
  id-token: write # Required for OIDC trusted publishing to npm
  contents: read

jobs:
  publish-npm:
    name: NPM Publication
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    timeout-minutes: 5
    env:
      CI: true
      BUN_INSTALL_CACHE_DIR: ~/.bun/install/cache

    steps:
      - name: Validate confirmation
        if: ${{ github.event.inputs.confirm != 'CONFIRM' }}
        run: |
          echo "‚ùå NPM publish not confirmed. Please type 'CONFIRM' to proceed."
          echo "‚ÑπÔ∏è  This is a safety check to prevent accidental NPM publishes."
          exit 1

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull latest changes with version bump
        run: |
          echo "Ensuring we have the latest version bump commit..."
          git fetch origin master
          git checkout master
          git pull origin master
          echo "‚úÖ Latest changes pulled successfully"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.2.21"

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies for NPM publish..."
          bun install --frozen-lockfile || {
            echo "‚ùå Dependency installation failed"
            echo "‚ÑπÔ∏è  Check network connectivity and lockfile integrity"
            exit 1
          }
          echo "‚úÖ Dependencies installed successfully"
        timeout-minutes: 2

      - name: Verify package version
        run: |
          CURRENT_VERSION=$(bun --print 'JSON.parse(require("fs").readFileSync("package.json", "utf8")).version')
          EXPECTED_VERSION="${{ inputs.version }}"

          if [ "$CURRENT_VERSION" != "$EXPECTED_VERSION" ]; then
            echo "‚ùå Version mismatch - package.json has $CURRENT_VERSION but expected $EXPECTED_VERSION"
            echo "‚ÑπÔ∏è  Please ensure the version has been updated in package.json first"
            echo "‚ÑπÔ∏è  You may need to run a release workflow first"
            exit 1
          fi

          echo "‚úÖ Package version verified: $CURRENT_VERSION"

      - name: Setup Node.js for npm publish
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Publish to NPM
        run: |
          echo "üì¶ Publishing v${{ inputs.version }} to NPM..."

          # Publish to npm using OIDC trusted publishing (--provenance enables OIDC auth)
          if ! npm publish --provenance --access public; then
            echo "‚ùå NPM publishing failed"
            echo "‚ÑπÔ∏è  Check package.json configuration and npm registry permissions"
            echo "‚ÑπÔ∏è  Version may already exist or package name may be taken"
            echo "‚ÑπÔ∏è  Ensure trusted publisher is configured on npmjs.com for this repository"
            echo "‚ÑπÔ∏è  Trusted publisher should be configured for workflow: publish-npm-manual.yml"
            exit 1
          fi

          echo "‚úÖ Successfully published v${{ inputs.version }} to NPM using trusted publishing"
          echo "NPM package: https://www.npmjs.com/package/hone-ai"
        timeout-minutes: 2

      - name: Publication summary
        run: |
          echo "‚úÖ NPM publication completed successfully!"
          echo "Version: v${{ inputs.version }}"
          echo "Package URL: https://www.npmjs.com/package/hone-ai"
          echo ""
          echo "üîß Configuration reminder:"
          echo "  Make sure NPM trusted publisher is configured at:"
          echo "  https://www.npmjs.com/package/hone-ai/access"
          echo "  Workflow filename: publish-npm-manual.yml"
          echo "  Organization: oskarhane"
          echo "  Repository: hone-ai"
