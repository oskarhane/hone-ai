name: Release Minor Version

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "CONFIRM" to proceed with minor release'
        required: true
        default: ""

permissions:
  contents: write
  pull-requests: read
  id-token: write # Required for OIDC trusted publishing to npm via called workflow

jobs:
  release-minor:
    name: Minor Version Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      new_version: ${{ steps.new_version.outputs.version }}
    env:
      CI: true
      BUN_INSTALL_CACHE_DIR: ~/.bun/install/cache

    steps:
      - name: Validate confirmation
        if: ${{ github.event.inputs.confirm != 'CONFIRM' }}
        run: |
          echo "âŒ Minor release not confirmed. Please type 'CONFIRM' to proceed."
          echo "â„¹ï¸  This is a safety check to prevent accidental minor releases."
          echo "â„¹ï¸  Minor releases add new features and increment the minor version number."
          exit 1

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.2.21"

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies for build..."
          bun install --frozen-lockfile || {
            echo "âŒ Dependency installation failed"
            echo "â„¹ï¸  Check network connectivity and lockfile integrity"
            exit 1
          }
          echo "âœ… Dependencies installed successfully"
        timeout-minutes: 2

      - name: Validate git repository
        run: |
          if ! git status > /dev/null 2>&1; then
            echo "âŒ Not a git repository or git is not available"
            echo "â„¹ï¸  This workflow requires a valid git repository with proper permissions"
            exit 1
          fi
          echo "âœ… Git repository validated"

      - name: Get current version
        id: current_version
        run: |
          CURRENT_VERSION=$(bun --print 'JSON.parse(require("fs").readFileSync("package.json", "utf8")).version')
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Validate version format
        run: |
          CURRENT="${{ steps.current_version.outputs.current }}"
          if [[ ! $CURRENT =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Current version '$CURRENT' does not match semantic versioning format (x.y.z)"
            exit 1
          fi
          echo "âœ… Version format validated"

      - name: Bump minor version using npm
        id: new_version
        run: |
          echo "Bumping minor version using npm version command..."

          # Verify npm is available
          if ! command -v npm &> /dev/null; then
            echo "âŒ npm command not found"
            echo "â„¹ï¸  npm is required for version bumping"
            exit 1
          fi
          echo "âœ… npm verified: $(npm --version)"

          # Configure git for npm version command
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Use npm version to bump minor version (this updates package.json and creates a git commit and tag)
          NEW_VERSION=$(npm version minor --no-git-tag-version --preid="")

          # Clean the version (remove 'v' prefix if present)
          NEW_VERSION=${NEW_VERSION#v}

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

          # Verify the version was updated correctly
          UPDATED_VERSION=$(bun --print 'JSON.parse(require("fs").readFileSync("package.json", "utf8")).version')
          if [ "$UPDATED_VERSION" != "$NEW_VERSION" ]; then
            echo "âŒ Version update failed - expected $NEW_VERSION, got $UPDATED_VERSION"
            exit 1
          fi
          echo "âœ… Version updated successfully to $NEW_VERSION"

      - name: Build standalone binary
        run: |
          echo "Building standalone binary..."
          bun run build
        timeout-minutes: 3

      - name: Verify binary build
        run: |
          if [ ! -f "./hone" ]; then
            echo "âŒ Binary build failed - hone executable not found in current directory"
            echo "â„¹ï¸  Expected binary at: $(pwd)/hone"
            echo "â„¹ï¸  Check build script configuration and ensure 'bun run build' produces the binary"
            ls -la . || true
            exit 1
          fi
          echo "âœ… Binary build successful"
          ls -la ./hone
          echo "Binary size: $(du -h ./hone | cut -f1)"

      - name: Prepare macOS binary for release
        run: |
          echo "ðŸŽ Preparing macOS binary for release..."

          # Ensure binary has proper permissions
          chmod +x ./hone

          # Create zip file with proper naming (keep binary named 'hone' inside zip)
          VERSION="${{ steps.new_version.outputs.version }}"
          ZIP_NAME="hone-v${VERSION}-macos.zip"
          zip "$ZIP_NAME" hone

          echo "âœ… macOS binary prepared:"
          echo "  Binary: hone (inside zip archive)"
          echo "  Archive: $ZIP_NAME"
          ls -la ./hone "./$ZIP_NAME"
          echo "Archive size: $(du -h "./$ZIP_NAME" | cut -f1)"

      - name: Sync with remote before committing
        run: |
          git fetch origin master
          if [ "$(git rev-parse HEAD)" != "$(git rev-parse origin/master)" ]; then
            echo "ðŸ”„ Remote has changes, pulling latest..."
            git pull --rebase origin master || (echo "âŒ Failed to sync with remote" && exit 1)
          fi
        timeout-minutes: 2

      - name: Commit version bump
        run: |
          git add package.json
          git commit -m "chore: bump version to ${{ steps.new_version.outputs.version }}"

      - name: Create and push git tag
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          git tag -a "v$NEW_VERSION" -m "Release version $NEW_VERSION"
           git push origin "v$NEW_VERSION"
           git push origin master
        timeout-minutes: 2

      - name: Create GitHub Release with binary
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        timeout-minutes: 3
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          CURRENT_VERSION="${{ steps.current_version.outputs.current }}"

          # Generate release notes from commit history
          echo "Generating release notes from commit history..."

          # Get the previous tag to generate changelog from
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "Generating changelog from $PREVIOUS_TAG to current commit..."
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" "$PREVIOUS_TAG"..HEAD | head -20)
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="No significant changes found in commit history."
            fi
          else
            echo "No previous tag found, generating changelog from first commit..."
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --max-count=20)
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="Initial release."
            fi
          fi

          # Create release notes with changelog
          RELEASE_NOTES="## Minor Release v$NEW_VERSION

          This is a minor version release with new features and improvements.

          ### What's Changed
          $CHANGELOG

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG:-$(git rev-list --max-parents=0 HEAD)}...v$NEW_VERSION"

          # Create GitHub release with auto-generated notes
          echo "ðŸš€ Creating GitHub release..."
          if ! gh release create "v$NEW_VERSION" \
            --title "Release v$NEW_VERSION" \
            --notes "$RELEASE_NOTES" \
            --latest; then
            echo "âŒ Failed to create GitHub release"
            echo "â„¹ï¸  Check GitHub token permissions and repository access"
            exit 1
          fi

           # Attach macOS binary archive to release
           echo "ðŸ“Ž Attaching macOS binary archive to release..."
           ZIP_NAME="hone-v$NEW_VERSION-macos.zip"
           if ! gh release upload "v$NEW_VERSION" "./$ZIP_NAME" --clobber; then
             echo "âŒ Failed to upload binary archive to release"
             echo "â„¹ï¸  Release created but binary attachment failed"
             echo "â„¹ï¸  You may need to manually attach the binary archive"
             exit 1
           fi
           
           echo "âœ… GitHub release created with auto-generated notes and macOS binary archive"

      - name: Clean up build artifacts
        run: |
          echo "ðŸ§¹ Cleaning up build artifacts..."
          rm -f ./hone ./hone-v${{ steps.new_version.outputs.version }}-macos.zip ./hone.map 2>/dev/null || true
          echo "âœ… Build artifacts cleaned up"

      - name: Release summary
        run: |
          echo "âœ… Minor release completed successfully!"
          echo "Version: ${{ steps.current_version.outputs.current }} â†’ ${{ steps.new_version.outputs.version }}"
          echo "Git tag: v${{ steps.new_version.outputs.version }} created"
          echo "Package.json updated and committed"
          echo "macOS binary built, zipped as 'hone', and attached to GitHub release as hone-v${{ steps.new_version.outputs.version }}-macos.zip"
          echo "GitHub Release URL: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.new_version.outputs.version }}"

  publish-to-npm:
    name: Publish to NPM
    needs: release-minor
    uses: ./.github/workflows/publish-npm.yml
    with:
      version: ${{ needs.release-minor.outputs.new_version }}
      release-type: "minor"

  final-summary:
    name: Final Summary
    needs: [release-minor, publish-to-npm]
    runs-on: ubuntu-latest
    steps:
      - name: Complete release summary
        run: |
          echo "ðŸŽ‰ Minor release v${{ needs.release-minor.outputs.new_version }} completed successfully!"
          echo "ðŸ“‹ Release Summary:"
          echo "  â€¢ GitHub Release: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.release-minor.outputs.new_version }}"
          echo "  â€¢ NPM Package: https://www.npmjs.com/package/hone-ai"
          echo "  â€¢ macOS Binary: Available in GitHub release as hone-v${{ needs.release-minor.outputs.new_version }}-macos.zip"
