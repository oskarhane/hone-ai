name: Release Minor Version

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "CONFIRM" to proceed with minor release'
        required: true
        default: ""

permissions:
  contents: write
  pull-requests: read
  id-token: write # Required for OIDC trusted publishing to npm via called workflow

jobs:
  prepare-release:
    name: Prepare Minor Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      new_version: ${{ steps.new_version.outputs.version }}
      current_version: ${{ steps.current_version.outputs.current }}
    env:
      CI: true
      BUN_INSTALL_CACHE_DIR: ~/.bun/install/cache

    steps:
      - name: Validate confirmation
        if: ${{ github.event.inputs.confirm != 'CONFIRM' }}
        run: |
          echo "âŒ Minor release not confirmed. Please type 'CONFIRM' to proceed."
          echo "â„¹ï¸  This is a safety check to prevent accidental minor releases."
          echo "â„¹ï¸  Minor releases add new features and increment the minor version number."
          exit 1

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.2.21"

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies for version bump..."
          bun install --frozen-lockfile || {
            echo "âŒ Dependency installation failed"
            echo "â„¹ï¸  Check network connectivity and lockfile integrity"
            exit 1
          }
          echo "âœ… Dependencies installed successfully"
        timeout-minutes: 2

      - name: Validate git repository
        run: |
          if ! git status > /dev/null 2>&1; then
            echo "âŒ Not a git repository or git is not available"
            echo "â„¹ï¸  This workflow requires a valid git repository with proper permissions"
            exit 1
          fi
          echo "âœ… Git repository validated"

      - name: Get current version
        id: current_version
        run: |
          CURRENT_VERSION=$(bun --print 'JSON.parse(require("fs").readFileSync("package.json", "utf8")).version')
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Validate version format
        run: |
          CURRENT="${{ steps.current_version.outputs.current }}"
          if [[ ! $CURRENT =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Current version '$CURRENT' does not match semantic versioning format (x.y.z)"
            exit 1
          fi
          echo "âœ… Version format validated"

      - name: Bump minor version using npm
        id: new_version
        run: |
          echo "Bumping minor version using npm version command..."

          # Verify npm is available
          if ! command -v npm &> /dev/null; then
            echo "âŒ npm command not found"
            echo "â„¹ï¸  npm is required for version bumping"
            exit 1
          fi
          echo "âœ… npm verified: $(npm --version)"

          # Configure git for npm version command
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Use npm version to bump minor version (this updates package.json)
          NEW_VERSION=$(npm version minor --no-git-tag-version --preid="")

          # Clean the version (remove 'v' prefix if present)
          NEW_VERSION=${NEW_VERSION#v}

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

          # Verify the version was updated correctly
          UPDATED_VERSION=$(bun --print 'JSON.parse(require("fs").readFileSync("package.json", "utf8")).version')
          if [ "$UPDATED_VERSION" != "$NEW_VERSION" ]; then
            echo "âŒ Version update failed - expected $NEW_VERSION, got $UPDATED_VERSION"
            exit 1
          fi
          echo "âœ… Version updated successfully to $NEW_VERSION"

      - name: Sync with remote before committing
        run: |
          git fetch origin master
          if [ "$(git rev-parse HEAD)" != "$(git rev-parse origin/master)" ]; then
            echo "ðŸ”„ Remote has changes, pulling latest..."
            git pull --rebase origin master || (echo "âŒ Failed to sync with remote" && exit 1)
          fi
        timeout-minutes: 2

      - name: Commit version bump
        run: |
          git add package.json
          git commit -m "chore: bump version to ${{ steps.new_version.outputs.version }}"

      - name: Create and push git tag
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          git tag -a "v$NEW_VERSION" -m "Release version $NEW_VERSION"
          git push origin "v$NEW_VERSION"
          git push origin master
        timeout-minutes: 2

      - name: Prepare release summary
        run: |
          echo "âœ… Minor release preparation completed!"
          echo "Version: ${{ steps.current_version.outputs.current }} â†’ ${{ steps.new_version.outputs.version }}"
          echo "Git tag: v${{ steps.new_version.outputs.version }} created"
          echo "Package.json updated and committed"
          echo "Ready for binary builds and GitHub release creation..."

  build-linux:
    name: Build Linux Binary
    runs-on: ubuntu-latest
    needs: prepare-release
    timeout-minutes: 5
    env:
      CI: true
      BUN_INSTALL_CACHE_DIR: ~/.bun/install/cache

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: v${{ needs.prepare-release.outputs.new_version }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.2.21"

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies for Linux build..."
          bun install --frozen-lockfile || {
            echo "âŒ Dependency installation failed"
            exit 1
          }
          echo "âœ… Dependencies installed successfully"
        timeout-minutes: 2

      - name: Build Linux binary
        run: |
          echo "ðŸ§ Building Linux binary..."
          bun run build:linux
        timeout-minutes: 3

      - name: Verify Linux binary
        run: |
          if [ ! -f "./hone-linux" ]; then
            echo "âŒ Linux binary build failed - expected hone-linux executable"
            ls -la . || true
            exit 1
          fi
          echo "âœ… Linux binary build successful"
          ls -la ./hone-linux
          echo "Linux binary size: $(du -h ./hone-linux | cut -f1)"

      - name: Prepare Linux binary for release
        run: |
          VERSION="${{ needs.prepare-release.outputs.new_version }}"
          echo "ðŸ§ Preparing Linux binary for release..."

          # Create folder structure and prepare binary
          chmod +x ./hone-linux
          LINUX_FOLDER="hone-v${VERSION}-linux"
          mkdir -p "$LINUX_FOLDER"
          cp ./hone-linux "./$LINUX_FOLDER/hone"
          LINUX_ZIP_NAME="hone-v${VERSION}-linux.zip"
          zip -r "$LINUX_ZIP_NAME" "$LINUX_FOLDER"
          rm -rf "$LINUX_FOLDER"

          echo "âœ… Linux binary prepared:"
          echo "  Archive: $LINUX_ZIP_NAME"
          ls -la "./$LINUX_ZIP_NAME"
          echo "Linux archive size: $(du -h "./$LINUX_ZIP_NAME" | cut -f1)"

      - name: Upload Linux binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: hone-v${{ needs.prepare-release.outputs.new_version }}-linux
          path: hone-v${{ needs.prepare-release.outputs.new_version }}-linux.zip
          retention-days: 1

  build-macos:
    name: Build macOS Binary
    runs-on: macos-latest
    needs: prepare-release
    timeout-minutes: 5
    env:
      CI: true
      BUN_INSTALL_CACHE_DIR: ~/.bun/install/cache

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: v${{ needs.prepare-release.outputs.new_version }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.2.21"

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies for macOS build..."
          bun install --frozen-lockfile || {
            echo "âŒ Dependency installation failed"
            exit 1
          }
          echo "âœ… Dependencies installed successfully"
        timeout-minutes: 2

      - name: Build macOS binary
        run: |
          echo "ðŸŽ Building macOS binary..."
          bun run build:macos
        timeout-minutes: 3

      - name: Verify macOS binary
        run: |
          if [ ! -f "./hone-macos" ]; then
            echo "âŒ macOS binary build failed - expected hone-macos executable"
            ls -la . || true
            exit 1
          fi
          echo "âœ… macOS binary build successful"
          ls -la ./hone-macos
          echo "macOS binary size: $(du -h ./hone-macos | cut -f1)"
          echo "Binary type: $(file ./hone-macos)"

      - name: Test macOS binary functionality
        run: |
          echo "ðŸ§ª Testing macOS binary functionality..."
          chmod +x ./hone-macos
          ./hone-macos --version || {
            echo "âŒ macOS binary is not functional"
            echo "â„¹ï¸  Binary was built but cannot execute properly"
            exit 1
          }
          echo "âœ… macOS binary is functional"

      - name: Prepare macOS binary for release
        run: |
          VERSION="${{ needs.prepare-release.outputs.new_version }}"
          echo "ðŸŽ Preparing macOS binary for release..."

          # Create folder structure and prepare binary
          chmod +x ./hone-macos
          MACOS_FOLDER="hone-v${VERSION}-macos"
          mkdir -p "$MACOS_FOLDER"
          cp ./hone-macos "./$MACOS_FOLDER/hone"
          MACOS_ZIP_NAME="hone-v${VERSION}-macos.zip"
          zip -r "$MACOS_ZIP_NAME" "$MACOS_FOLDER"
          rm -rf "$MACOS_FOLDER"

          echo "âœ… macOS binary prepared:"
          echo "  Archive: $MACOS_ZIP_NAME"
          ls -la "./$MACOS_ZIP_NAME"
          echo "macOS archive size: $(du -h "./$MACOS_ZIP_NAME" | cut -f1)"

      - name: Upload macOS binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: hone-v${{ needs.prepare-release.outputs.new_version }}-macos
          path: hone-v${{ needs.prepare-release.outputs.new_version }}-macos.zip
          retention-days: 1

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare-release, build-linux, build-macos]
    timeout-minutes: 5
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: v${{ needs.prepare-release.outputs.new_version }}
          fetch-depth: 0

      - name: Download Linux binary
        uses: actions/download-artifact@v4
        with:
          name: hone-v${{ needs.prepare-release.outputs.new_version }}-linux

      - name: Download macOS binary
        uses: actions/download-artifact@v4
        with:
          name: hone-v${{ needs.prepare-release.outputs.new_version }}-macos

      - name: Generate release notes
        id: release_notes
        run: |
          NEW_VERSION="${{ needs.prepare-release.outputs.new_version }}"
          CURRENT_VERSION="${{ needs.prepare-release.outputs.current_version }}"

          echo "Generating release notes from commit history..."

          # Get the previous tag to generate changelog from
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "Generating changelog from $PREVIOUS_TAG to current commit..."
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" "$PREVIOUS_TAG"..HEAD | head -20)
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="No significant changes found in commit history."
            fi
          else
            echo "No previous tag found, generating changelog from first commit..."
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --max-count=20)
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="Initial release."
            fi
          fi

          # Create release notes with changelog and save to file
          cat > release_notes.md << EOF
          ## Minor Release v$NEW_VERSION

          This is a minor version release with new features and improvements.

          ### What's Changed
          $CHANGELOG

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG:-$(git rev-list --max-parents=0 HEAD)}...v$NEW_VERSION
          EOF

      - name: Create GitHub release
        run: |
          NEW_VERSION="${{ needs.prepare-release.outputs.new_version }}"

          echo "ðŸš€ Creating GitHub release..."
          if ! gh release create "v$NEW_VERSION" \
            --title "Release v$NEW_VERSION" \
            --notes-file release_notes.md \
            --latest; then
            echo "âŒ Failed to create GitHub release"
            echo "â„¹ï¸  Check GitHub token permissions and repository access"
            exit 1
          fi

      - name: Upload release binaries
        run: |
          NEW_VERSION="${{ needs.prepare-release.outputs.new_version }}"

          echo "ðŸ“Ž Attaching binary archives to release..."
          LINUX_ZIP_NAME="hone-v$NEW_VERSION-linux.zip"
          MACOS_ZIP_NAME="hone-v$NEW_VERSION-macos.zip"

          if ! gh release upload "v$NEW_VERSION" "./$LINUX_ZIP_NAME" --clobber; then
            echo "âŒ Failed to upload Linux binary archive to release"
            echo "â„¹ï¸  Release created but Linux binary attachment failed"
            exit 1
          fi

          if ! gh release upload "v$NEW_VERSION" "./$MACOS_ZIP_NAME" --clobber; then
            echo "âŒ Failed to upload macOS binary archive to release"
            echo "â„¹ï¸  Release created but macOS binary attachment failed"
            exit 1
          fi

          echo "âœ… GitHub release created with auto-generated notes and both platform binary archives"

  final-summary:
    name: Final Summary
    needs: [prepare-release, create-release]
    runs-on: ubuntu-latest
    steps:
      - name: Complete release summary
        run: |
          echo "ðŸŽ‰ Minor release v${{ needs.prepare-release.outputs.new_version }} completed successfully!"
          echo "ðŸ“‹ Release Summary:"
          echo "  â€¢ GitHub Release: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.prepare-release.outputs.new_version }}"
          echo "  â€¢ Linux Binary: Available in GitHub release as hone-v${{ needs.prepare-release.outputs.new_version }}-linux.zip"
          echo "  â€¢ macOS Binary: Available in GitHub release as hone-v${{ needs.prepare-release.outputs.new_version }}-macos.zip (built on native macOS runner)"
          echo ""
          echo "ðŸ“¦ To publish to NPM:"
          echo "  1. Go to: https://github.com/${{ github.repository }}/actions/workflows/publish-npm-manual.yml"
          echo "  2. Click 'Run workflow' button"
          echo "  3. Enter version: ${{ needs.prepare-release.outputs.new_version }}"
          echo "  4. Type 'CONFIRM' to proceed"
          echo ""
          echo "ðŸ”§ NPM Trusted Publisher Configuration:"
          echo "  Configure at: https://www.npmjs.com/package/hone-ai/access"
          echo "  Workflow filename: publish-npm-manual.yml"
